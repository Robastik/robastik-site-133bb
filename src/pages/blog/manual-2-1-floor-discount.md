---
title: Расчет корректировки на этаж 
subtitle: Часть 1. Сбор и подготовка данных
date: '2023-04-27'
excerpt: Пошаговая иллюстрированная инструкция в двух частях. Часть 1. Сбор и подготовка данных
image_alt: анализ этажности
thumb_image_alt: Кластеры застройки по этажности
meta_title: Корректировка на этаж
meta_description: Подготовка данных
canonical_url: ' '
no_index: false
template: post
author: src/data/authors/jane-doe.yaml
thumb_image: images/manual-2-1-floor-discount/0.png
image: images/manual-2-1-floor-discount/0.png
---
Пошаговая иллюстрированная инструкция по решению задачи анализа этажности городской застройки, в т.ч. расчет скидок за первый и последний этажи. В качестве модельного города принят Брянск. Расчетный файл прилагается и его листы пронумерованы в последовательности выполненных операций. Шаблон расчета легко адаптировать для другого города и вида недвижимости.

Инструкция состоит из двух частей. В первой части изложен порядок подготовки, первичного ознакомления с данными и уточнения цели исследования. Во второй части будет сделан расчет скидки за этаж.

1. Что потребуется

Для _построения инфраструктуры работы с большими данными_ в данном случае потребуется только Excel. Excel соберет данные с досок объявлений, Excel их подготовит для использования, Excel их визуализирует и преобразует в знания. Вы знакомы с Excel? → если да, то вы уже не офисный планктон, а _опытный дата-инженер_ и _дата-аналитик_!

_Настройка инфраструктуры_ для нашего _кейса_ заключается в _конфигурировании_ Excel двумя надстройками. Надстройка _[Power Query](https://en.wikipedia.org/wiki/Power_Query)_ предоставляет средства _[ETL](https://ru.wikipedia.org/wiki/ETL)_. Надстройка _[Робастик](https://robastik.ru/)_ предоставляет средства автоматизации.

2. Данные

Исходный _набор данных_ собран с досок объявлений. _Датасет_ состоит из 15 файлов в одной папке, в каждом из которых находятся собранные в течение календарного месяца объявления (ежемесячный срез рынка). Инструкция для парсинга объявлений недвижимости изложена в одной из [предыдущих публикаций](https://robastik.ru/blog/manual-1-simple-map-and-data-clearing/).

3. Получение данные

Для извлечения данных из датасета используем Power Query. В разных версиях Excel меню Power Query выглядит по-разному. В версиях 2010 и 2013 ее надо устанавливать дополнительно, а с 2016 она идет в составе Excel.

Для объединения данных из 15 файлов и вставки в лист новой книги нужно сделать несколько кликов.

В версии 2019 это меню находится здесь:

![](1.png)

В версии 2013 это меню находится здесь:

![](2.png)

Затем объединяем и загружаем:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/4728e3fa769841e859a1937bceb18641.png)

Добавить картинку

После чего остается выбрать лист с данными:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/e4f1e3959878c580d879f8c9deb7c622.png)

Добавить картинку

Поскольку парсер автоматически формирует названия листов, названия листов с данными по квартирам в Брянске будут одинаковыми во всех файлах. В результате на одном листе №1 будут объединены в одну таблицу все имеющиеся данные из всех файлов в папке с листов, имеющих одинаковое название.

Всего таким образом извлечено порядка 150 тысяч записей. Для масштаба _enterprise_ это ничто. Для локального МСБ это вполне Big Data.

Удалить

Заголовок 1

Заголовок 2

Заголовок 3

4. Transform

Удалить

Заголовок 1

Заголовок 2

Заголовок 3

Удаление лишних колонок

Исходные данные расположены в 49 колонках. Данные из большинства колонок не потребуются. Удаляем лишние колонки данных.

В версии 2019 это выглядит так:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/ef8ba164b316db4a324487d71de92722.png)

Добавить картинку

В версии 2013 это выглядит так:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/7cd2738ab23dd3757e1abd3ad5d69062.png)

Добавить картинку

И затем либо удаляем лишние столбы, либо выбираем те, которые надо оставить.

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/e703c1949d24f41104a8106a3f42604f.png)

Добавить картинку

В завершение размещаем результат на новый лист №2:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/f1d5dd08b70eebf8765b275a69532c9d.jpg)

Добавить картинку

Теперь переходим к работе со строками.

Удалить

Заголовок 1

Заголовок 2

Заголовок 3

Удаление дубликатов

Поскольку в задаче не предполагается сопоставление помесячных срезов, дубликаты нам не потребуются.

Для удаления дубликатов делаем активным лист №2 → из таблицы → выделить колонку itemID →

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/2c7f97a1c20f961037d6144293197d09.jpg)

Добавить картинку

удалить строки → удалить дубликаты:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/f9c790d6519806833b16ed68c70b7092.jpg)

Добавить картинку

itemID  - это номера объявлений. Удаление строк с дублирующимися номерами объявлений означает, что будут удалены записи одного и того же объявления, опубликованного в течение разных месяцев.

В завершение размещаем результат на новый лист №3 → закрыть и загрузить.

Удалить

Заголовок 1

Заголовок 2

Заголовок 3

Удаление лишних категорий

В исходных данных собрана продажа, покупка и аренда. Ограничимся данными о продаже.

Также не станем рассматривать специфику новостроек, оставим только вторичный рынок.

Для этой операции делаем активным лист №3 → из таблицы → открыть фильтр колонки **Офер** → оставить галку **Продам** :

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/deeae3ec919027a867ea676918e29d1c.jpg)

Добавить картинку

Аналогично в колонке Рынок снять галку Новостройка:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/d034bc95d3debf4222861020a1e4ad16.jpg)

Добавить картинку

В завершение размещаем результат на новый лист №4: закрыть и загрузить.

На этом данные считаем подготовленными для анализа.

Отметим, что для подготовки данных потребовалось только немного пощелкать мышкой. Формулы не использовались совсем.

Удалить

Заголовок 1

Заголовок 2

Заголовок 3

5. Анализ

Удалить

Заголовок 1

Заголовок 2

Заголовок 3

Группы этажности

Для общего понимания города в аспекте этажности рассмотрим распределение зданий по этажности и размещение этажности на территории.

Делаем активным лист №4 → из таблицы → выделяем столбец **Этажность** → группировать:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/441b142d1183e80418e46af7df7b0207.png)

Добавить картинку

→ В таблице после группировки выбираем столбец Этажность → сортировать:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/4be80ccf30e5063d488c0fda231bece2.jpg)

Добавить картинку

В завершение размещаем результат на новый лист №5: закрыть и загрузить.

На листе №5 теперь расположена таблица:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/9df9ed6924516f85b3be5d382010cc77.jpg)

Добавить картинку

Для наглядного представления построим на этих данных график:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/fc7c61c87d09f615a99f693918c45368.png)

Добавить картинку

Как видим из графика, город преимущественно пятиэтажный. Помня о том, что данные парсились по запросу для Брянской области, можно предположить, что малоэтажки в значительной степени размазаны по территории всей области.

Следующую по численности группу составляют 9 – 10 –этажки. Последняя по количеству группа состоит из 14 – 17 –этажек.

Из визуальной оценки можно отметить, что каждой группе этажности соответствует свой исторический период. Каждый период характеризуется не только преобладающими нормами и технологией строительства, но и отношениями между властью и обществом (насколько можно уплотнить граждан на квадратном метре застройки), и преобладающим контингентом (пенсионеры, потомки тружеников промышленности, баловни периода «до», гетто времен «после», и т.д.).

Исходя из первичной оценки групп этажности сформируем внутри них территориальные кластеры. Благодаря этому будут получены однородные группы объектов с минимальным разбросом характеристик. Это позволит лучше выделить влияние фактора первого/последнего этажа благодаря низкому уровню шума от факторов местонахождения и этажности.

Разделим данные на группы этажности:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/1ab02a58d2e3b770ab5d248b972a7e21.jpg)

Добавить картинку

На графике:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/67267e2cf7ddcf1021e6f1ff5fc71a18.png)

Добавить картинку

Группы этажности

Удалить

Заголовок 1

Заголовок 2

Заголовок 3

Кластеры по территории

Подготовим данные для построения графика кластера для группы этажности 1 - 3.

Делаем активным лист №4 → из таблицы → выбрать столбцы → (удерживая Ctrl) широта, долгота, этажность.

В завершение размещаем результат на новый лист №6: закрыть и загрузить.

Делаем активным лист №6 → из таблицы → открыть фильтр колонки Этажность → оставить галки 1,2 и 3 → закрыть и загрузить в лист 7.1-3:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/04ddce75a5c0c9217bec558187546301.png)

Добавить картинку

Аналогично загружаем данные для группы 4 – 7 на лист 7.4-7, группы 8 – 12 на лист 7.8-12 и группы 13 – 19 на лист 7.13-19.

Далее создаем лист №8.1-3 и добавляем в него шаблон карты. Работа с картой подробно разобрана в [предыдущей статье](https://habr.com/ru/articles/693974/).

В шаблон карты вставляем ссылку на столбцы А:В в листе №7.1-3, синий цвет RGB имеет код 0,0,255.

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/cbd11afa20bf3ec3daa34bcd6f213d7a.png)

Добавить картинку

В результате получаем пустую карту где-то в Белоруссии:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/e7f27feb392a3c03a4a3379786cdcc98.png)

Добавить картинку

Это произошло оттого, что не стали чистить данные в колонках **Широта** и **Долгота**. Пустая карта не является проблемой → нужно позумить карту колесом мышки до тех пор, пока на ней не появятся отметки:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/4fb146a0b7af7a369fd99940baa06009.png)

Добавить картинку

Затем перетащить мышкой Брянск в центр карты и отзумить масштаб обратно:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/3370cdfb295d51fac18021491ead5b98.png)

Добавить картинку

Как и предполагалось, малоэтажные здания не формируют кварталы сплошной застройки.

Аналогично построим график на карте для остальных групп этажности.

Этажность 4 – 7 за пределами города сконцентрирована в районных центрах:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/2863511a2aaa8839639398d80bb7c92b.jpg)

Добавить картинку

В городе этажность 4 - 7 расположена кварталами сплошной застройки:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/b770bb1faa6ed9583b966b906116d72c.png)

Добавить картинку

Определим территориальный кластер на перекрестке улиц Литейная и Ново-Советская:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/79308c24fdfaba0260fd6c657a78fc21.png)

Добавить картинку

Откроем это место на сайте 2gis.ru и определим координаты центра кластера:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/7ac7aeb73a6b1a2675eddd7d029657b1.png)

Добавить картинку

Там же воспользуемся инструментом **Линейка** и измерим размер кластера (радиус окружности, вмещающей жилые строения):

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/865a3f26cb6a108bb7e632e4c3f52dc3.png)

Добавить картинку

С помощью этих данных можно определить окружность, включающую в себя объекты территориального кластера. Окружность используется для отбора входящих в кластер данных.

Аналогично повторим с территориальным кластером между улицами Костычева и Красноармейская – Авиационная:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/0af9ffeabc92179152f22f00f4f23ea4.png)

Добавить картинку

Поскольку кластер очень вытянутый, для его определения используем две окружности: 1) с центром 53.261924° 34.32897° и радиусом 700 метров, 2) с центром 53.253313° 34.334564° и радиусом 650 метров.

Построим выбранные территориальные кластеры на карте.

Воспользуемся функцией **Дистанция** :

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/e70f4f615b0a2ab1a6a3892350da59f7.png)

Добавить картинку

В кластер войдут те точки, дистанция от которых до центра кластера меньше радиуса окружности.

На листе №9.4-7 запишем сводку определяющих кластеры окружностей:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/f4b65f4ddeee8790c84bf08cab33d6cd.png)

Добавить картинку

По этим данным добавим на листе №7.4-7 новые столбцы с формулой для расчета. Если дистанция от точки до центра окружности меньше радиуса, то точка входит в кластер:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/2869244326f4aaa4a2e123acd8af02de.png)

Добавить картинку

Для формирования выборок точек, входящих и не входящих в территориальные кластеры делаем активным лист №7.4-7 →  из таблицы → в фильтре колонки Кластер 1 снять галку FALSE → удалить все столбцы, кроме широты и долготы → закрыть и загрузить → назвать новый лист 10.4-7.1.

Аналогично из кластера 2-1 загружаем в лист №10.4-7.21 и из кластера 2-2 загружаем в лист №10.4-7.22. Затем объединяем их в лист №10.4-7.2.

Чтобы получить выборку данных, не вошедших в территориальные кластеры, из таблицы на листе 7.4-7 вычитаем таблицы 10.4-7.1, 10.4-7.21 и 10.4-7.22 и загружаем в лист 10.4-7.0.

Заполняем шаблон карты:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/cb4abb2658f7dd1c4267a21a4ec416cd.png)

Добавить картинку

Отображаем результат:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/b4a9cd6f35ef7a49a9f9926384963b82.png)

Добавить картинку

Аналогично для этажности 8 – 12:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/f321af56637d44bb73547c4801654700.png)

Добавить картинку

И для 13 – 19:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/75f1acd637c24b9bf5bec5e2064b7c98.png)

Добавить картинку

В заключение – все кластеры вместе:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/54c4cb089af109188f2ef0a91eabd745.png)

Добавить картинку

Все использованные данные:

Удалить

Загрузить новую

![](/C:/Users/%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%D0%BE%D0%B2%D0%B0/Desktop/Transfer/57/2md/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8%20_%20%D0%A5%D0%B0%D0%B1%D1%80_files/f9eec07386e55820d6da0204ba2e55ab.png)

Добавить картинку

Стоит обратить внимание на то, что для подготовки данных потребовалась только одна формула.

Подготовленные данные далее будут использованы для расчета скидки на этаж во второй части инструкции.

Удалить

Файл с данными и с расчетами (в следующей части также скидки для первого и последнего этажа) можно скачать [здесь](https://github.com/Robastik/Habr/releases/download/1/Floor.discount.xlsx).