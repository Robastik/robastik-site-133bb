---
title: Как сделать тепловую карту цен на недвижимость 
subtitle: Без макросов и VBA в Excel
date: '2022-10-20'
excerpt: Строим карту цен в Excel без макросов и VBA
image_alt: Парсинг Авито и ЦИАН для тепловой карты цен
thumb_image_alt: Heatmap цен квартир по данным Авито и ЦИАН
meta_title: Строим карту цен в Excel без макросов и VBA
meta_description: Для квартир с Авито и ЦИАН
canonical_url: ' '
no_index: false
template: post
author: src/data/authors/jane-doe.yaml
thumb_image: images/habr-1-simple-map-and-data-clearing.png
image: images/habr-1-simple-map-and-data-clearing.png
---
Считается, что Data Mining — это магическое снадобье из SQL, Python, Power BI и других волшебных компонент. Мало кто знает, что при правильном подходе с Data Mining может совладать офисный планктон с помощью одного лишь Excel.

Если вы абсолютно далеки от Data Mining, но хотите причаститься его таинств, это руководство в картинках по шагам сделано для вас. Особенно полезно тем, кто никогда бы даже не подумал сделать подобное самостоятельно.

![Тепловая карта цен в Excel](https://habrastorage.org/r/w1560/getpro/habr/upload_files/b33/d3e/3aa/b33d3e3aab8af63a3695549607ec0c70.png "Тепловая карта цен в Excel")

Тепловая карта цен в Excel

В качестве практического вопроса будем рассматривать визуализацию данных из объявлений на популярных сайтах продажи квартир. Визуальный анализ — основа основ Data Mining, а при отсутствии специальных знаний — и вовсе единственный способ для понимания смысла, содержащегося в большом количестве данных. Это настолько фундаментальный навык, что ему посвящена целая народная мудрость:

> Лучше один раз увидеть, чем сто раз услышать\*

\*_Это все, что нужно знать о достоинствах визуального анализа_.

## Термины

**Тепловая карта** (heat map) – обозначение какого-либо показателя цветом:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/035/276/524/0352765243a555e72b27535efe8d6172.png)

Как правило, более высокие значения обозначаются красными оттенками, более низкие – синими. Обычная цветовая шкала выглядит так:

![](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/fde/1e0/2af/fde1e02af92a8d72e50f4b8cd1a15c02.jpg)

**Географическая тепловая карта** – обозначение показателя цветом на географической карте. Более высокие значения температуры показаны более красными оттенками в привязке к географическим точкам:

![](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/8d4/37e/c4b/8d437ec4bf4ac064e6d96e2a1d821ed0.jpg)

**Географическая тепловая карта цен** – обозначение цветом цен в разных географических местах.

В нашем случае это будут цены на квартиры.

## Данные

Цены на квартиры будем брать с общеизвестных досок объявлений А и Ц. Для сбора объявлений без программирования нужно воспользоваться готовым парсером. В данном случае выберем наиболее [доступный](https://robastik.ru/features-parsing) по причине его бесплатности и наиболее удобный из-за простоты установки в три клика в Excel.

Парсеру надо дать понять какие объявления нужно скачивать. Для этого используется ссылка на доску объявлений.

Для подготовки ссылки для скачивания объявлений с доски объявления А открываем браузер, в браузере открываем сайт доски объявлений, выбираем регион (для примера → Брянск) и раздел → квартиры. В адресном поле браузера получаем ссылку: https://www.avito.ru/bryanskaya\_oblast/kvartiry. В последней части ссылки видим раздел → kvartiry, перед ней расположен регион → bryanskaya\_oblast. Вместо Брянска можно указать свой регион, а вместо раздела квартир можно указать дома-дачи-коттеджи или земельные-участки. Также можно использовать фильтры (например новостройки или вторичка, количество комнат) и они отобразятся в составе ссылки. Скажем спасибо доске объявлений А за такой понятный порядок формирования ссылок.

Для подготовки ссылки с доски объявлений Ц придется сделать дополнительный шаг: после выбора региона, раздела, фильтров и нажатия кнопки «Найти» нужная ссылка еще не будет готова. Для завершения подготовки ссылки нужно перейти на вторую страницу списка объявлений. После этого ссылка в адресной строке браузера примет вид https:// cian.ru/cat.php?deal\_type=sale&engine\_version=2&offer\_type=flat&p=2&region=4562&room1=1&room2=1. Раздел квартир здесь будет в offer\_type=flat, а регион – в region=4562. Скажем «фу» доске объявлений Ц за не самый удобный порядок формирования ссылок.

Готовые ссылки как есть копируем из адресной строки браузера (нажатием кнопок Ctrl+A и Ctrl+C) и вставляем в парсере нажатием кнопки **Добавить ссылку**. Для обеих ссылок можно указать один и тот же новый файл Excel, в который будут сохраняться объявления.

Чтобы код для парсинга доски объявлений А загрузился в Excel → в настройках парсера (расположены в Excel на вкладке _Надстройки_) ставим галочку у парсера доски объявлений А и выключаем галочки у сохранения фотографий из объявлений, у сохранения копии объявлений, у открывания номера телефона и у других ненужных опций. То же самое повторяем с настройками парсера доски объявлений Ц.

Теперь ссылки полностью готовы для загрузки объявлений. Нажимаем в меню парсера кнопку **Старт** и ждем около 20 секунд до загрузки первого объявления. Да, процесс совсем не быстрый и займет время. Можно уменьшить интервал запросов в настройках парсера до 10 или 5 секунд и иногда это даже прокатывает. Но обычно доски объявлений очень не любят ботов и сразу закрывают доступ к данным (бан). Конечно, эти ограничения можно обойти и загружать данные в 100 раз быстрее, но это дороже.

Загружаемые объявления выглядят примерно так:

![Фрагмент листа Excel c загруженными парсером объявлениями Авито и ЦИАН](https://habrastorage.org/r/w1560/getpro/habr/upload_files/156/d6a/a83/156d6aa83a92419eb4ea314c3b78aa18.png "Фрагмент листа Excel c загруженными парсером объявлениями Авито и ЦИАН")

Фрагмент листа Excel c загруженными парсером объявлениями Авито и ЦИАН

Таких строк может быть несколько тысяч. В нашем примере это около 5000 объявлений для Брянской области в октябре 2021.

Из множества данных нам понадобятся только широта, долгота, цена, общая площадь и офер:

<table><tbody><tr><td><p>Широта</p></td><td><p>Долгота</p></td><td><p>Цена</p></td><td><p>Общая</p></td><td><p>Офер</p></td></tr><tr><td><p>53,2656</p></td><td><p>34,35292</p></td><td><p>5030000</p></td><td><p>64,2</p></td><td><p>Продам</p></td></tr><tr><td><p>53,20856</p></td><td><p>34,46647</p></td><td><p>2443000</p></td><td><p>51</p></td><td><p>Продам</p></td></tr><tr><td><p>53,26398</p></td><td><p>34,33171</p></td><td><p>10000</p></td><td><p>40</p></td><td><p>Сдам</p></td></tr><tr><td><p>53,54983</p></td><td><p>33,76486</p></td><td><p>750000</p></td><td><p>35</p></td><td><p>Продам</p></td></tr><tr><td><p>…</p></td><td></td><td></td><td></td><td></td></tr></tbody></table>

Это сырые данные, которые требуют подготовки.

## Подготовка

Отделим аренду от продажи. Для этого добавим фильтр по полю «офер» и выделим только предложения продажи. Можно и наоборот – оставить только предложения аренды и работать дальше с ними.

![Фильтр Excel](https://habrastorage.org/r/w1560/getpro/habr/upload_files/03a/ee8/9bd/03aee89bd305fdb70064d17e3a4a4414.png "Фильтр Excel")

Фильтр Excel

Выделим отфильтрованные данные, Ctrl+G → только видимые:

![Выделение только видимых ячеек](https://habrastorage.org/r/w1560/getpro/habr/upload_files/a6d/a80/9f6/a6da809f678199d75f152a06c991379a.png "Выделение только видимых ячеек")

Выделение только видимых ячеек

Копируем их Ctrl+C и вставим на новый лист Ctrl+V:

<table><tbody><tr><td><p>Широта</p></td><td><p>Долгота</p></td><td><p>Цена</p></td><td><p>Общая</p></td></tr><tr><td><p>53,2656</p></td><td><p>34,35292</p></td><td><p>5030000</p></td><td><p>64,2</p></td></tr><tr><td><p>53,20856</p></td><td><p>34,46647</p></td><td><p>2443000</p></td><td><p>51</p></td></tr><tr><td><p>53,54983</p></td><td><p>33,76486</p></td><td><p>750000</p></td><td><p>35</p></td></tr><tr><td><p>53,31711</p></td><td><p>34,30244</p></td><td><p>1450000</p></td><td><p>62</p></td></tr><tr><td><p>53,26612</p></td><td><p>34,33491</p></td><td><p>2950000</p></td><td><p>36</p></td></tr><tr><td><p>…</p></td><td></td><td></td><td></td></tr></tbody></table>

 Если показывать цены на многокомнатные квартиры одним цветом и цены однушек другим цветом, в результате получим карту размещения жилья по числу комнат. Для анализа цен этот показатель слишком сырой. Вместо него используем среднюю цену за квадратный метр.

При делении цены квартиры на общую площадь получим цену одного квадратного метра. Этот показатель лучше отражает ценность жилья с учетом всех ценообразующих факторов: расположения, состояния, отделки и окружения. Поэтому добавим колонку с ценой одного квадратного метра и уберем колонки с ценой и общей площадью:

<table><tbody><tr><td><p>Широта</p></td><td><p>Долгота</p></td><td><p>За 1 кв.м.</p></td></tr><tr><td><p>53,2656</p></td><td><p>34,35292</p></td><td><p>78348,91</p></td></tr><tr><td><p>53,20856</p></td><td><p>34,46647</p></td><td><p>47901,96</p></td></tr><tr><td><p>53,54983</p></td><td><p>33,76486</p></td><td><p>21428,57</p></td></tr><tr><td><p>53,31711</p></td><td><p>34,30244</p></td><td><p>23387,1</p></td></tr><tr><td><p>53,26612</p></td><td><p>34,33491</p></td><td><p>81944,44</p></td></tr><tr><td><p>…</p></td><td></td><td></td></tr></tbody></table>

Теперь проведем стандартные процедуры проверки заведомо ошибочных данных.

У нас есть две группы данных: географическое положение и цена. Для проверки обеих групп используем визуальный контроль.

Поместим имеющиеся географические точки на обычную диаграмму Excel:

![Ошибочные данные выглядят так](https://habrastorage.org/r/w1560/getpro/habr/upload_files/51d/7c1/e71/51d7c1e71741476c618988e85010d87e.png "Ошибочные данные выглядят так")

Ошибочные данные выглядят так

Посмотрим координаты [крайних точек Брянской области](https://ru.wikipedia.org/wiki/%D0%93%D0%B5%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%8F_%D0%91%D1%80%D1%8F%D0%BD%D1%81%D0%BA%D0%BE%D0%B9_%D0%BE%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D0%B8#%D0%93%D0%B5%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D0%BF%D0%BE%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5). Широта должна быть от 51,5039 до 54,021, долгота от 31,1432 до 35,1917. Некоторые наши точки выходят за эти пределы. Опустим здесь рассмотрение причин появления испорченных данных и возможных путей их восстановления, т.к. это не относится прямо к цели визуализации данных и противоречит принятому ограничению квалификации пользователя. По этой же причине используем грубый, но простой способ избавления от испорченных данных.

Заменим нулями строки, где долгота и широта выходят за границы региона → с помощью простой формулы:

![Обнуление ошибочных данных](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/ce6/0d5/976/ce60d5976ee45fc8fd114125b66a26bf.jpg "Обнуление ошибочных данных")

Обнуление ошибочных данных

Затем добавим фильтр и уберем отображение строк с нолями:

![Фильтр выбора ненулевых данных](https://habrastorage.org/r/w1560/getpro/habr/upload_files/2c3/e4c/376/2c3e4c37628877ed0b42b28f1da94232.png "Фильтр выбора ненулевых данных")

Фильтр выбора ненулевых данных

Выделим все строки отфильтрованных колонок данных, затем Сtrl+G → только видимые:

![Повторенье — мать ученья](https://habrastorage.org/r/w1560/getpro/habr/upload_files/9ec/710/01f/9ec71001f851a36397b1d239a22fc28a.png "Повторенье — мать ученья")

Повторенье — мать ученья

Копируем их Ctrl+C и вставим в новое место (рядом) Ctrl+V.

Очищенные таким образом долготы и широты точек отправляем на новую диаграмму Excel и видим результат очистки:

![Данные без географических ошибок](https://habrastorage.org/r/w1560/getpro/habr/upload_files/0c5/a61/680/0c5a616802d24d31680e304e9c882878.png "Данные без географических ошибок")

Данные без географических ошибок

Теперь также с помощью визуального анализа очистим данные о ценах.

Для этого построим гистограмму, чтобы посмотреть сколько каких значений цены в нашей выборке.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/e06/542/5ad/e065425ad1ad1dfe18a72cce12d6172a.png)

Почему график именно такой

_Город рос в естественных условиях (построен не одномоментно по единому плану), имеет развитое сельское хозяйство и небольшие промышленные предприятия (не лакшери центр). Теория говорит, что при таких обстоятельствах цены на финансовые активы (жилье – один из базовых финансовых активов) должны быть распределены логнормально._

_Присутствие на гистограмме длиннющего тощего хвоста и асимметрия основной части распределения являются характерными признаками логнормального распределения. То есть в данном случае практика соответствует теории._

Практический смысл этой гистограммы: если данные из правой части отметить на карте одним цветом, из средней — вторым и из левой — третьим, то вся карта будет залита одним цветом. Потому что в средней и в правой частях точек почти нет. Аналитического смысла у такой карты не будет.

Чтобы избавиться от упомянутого эффекта нужно отбросить хвост распределения, а заодно и данные из первого левого кармана. В результате получим такую гистограмму:

![Те же данные в другом горизонтальном масштабе](https://habrastorage.org/r/w1560/getpro/habr/upload_files/6f6/de6/423/6f6de64236804dbd5ce14dcd9018f67c.png "Те же данные в другом горизонтальном масштабе")

Те же данные в другом горизонтальном масштабе

Теперь количество данных в разных частях более-менее сопоставимо. Количество карманов здесь посчитано Excel автоматически и оно явно избыточно для того, чтобы каждый уровень цены обозначать своим цветом. Поэтому в дальнейшем перестроим гистограмму по количеству карманов в соответствии с количеством цветов, которые будут использованы на карте. В нашем случае будем использовать 7 цветов.

Перед разбивкой данных по карманам рассмотрим еще одно обстоятельство, которое стоит учесть на этапе подготовки данных. Дело в том, что точки на карте могут располагаться слишком тесно. Например, здесь шесть объявлений расположены в одном доме и перекрывают друг друга даже на самом крупном масштабе:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/139/393/12f/13939312f05db2293258da142980f2a3.png)

На более мелких масштабах эти метки полностью сольются и станут неразличимы.

Чтобы избавиться от излишней в данном случае детализации данных проведем их усреднение. Для усреднения данных воспользуемся следующим приемом.

Обычная точность указания координат использует 6 знаков после запятой. Например, широта 52,549374 и долгота 31,897056. Четвертый знак после запятой соответствует масштабу придомовой территории. В нашем примере в диапазон долготы от 31,89**65** до 31,89**74** попадают все объявления, относящиеся к одному строению. Используем это обстоятельство для группировки данных в процессе усреднения.

Добавляем к имеющимся данным столбцы с округленными до 3 знака широтой и долготой. Еще одним столбцом добавляем символьную сумму этих двух последних столбцов:

![Формулы округления координат](https://habrastorage.org/r/w1560/getpro/habr/upload_files/db3/cee/d74/db3ceed7457870fc15a434b4f59b05dc.png "Формулы округления координат")

Формулы округления координат

Что в результате дает:

![Результат округления координат](https://habrastorage.org/r/w1560/getpro/habr/upload_files/208/662/740/20866274072f388bb04613c4b3aec8c4.png "Результат округления координат")

Результат округления координат

После чего сортируем все столбцы по колонке с текстом и применяем **Промежуточный итог**:

![Стандартный инструмент Excel на вкладке Данные → Структура](https://habrastorage.org/r/w1560/getpro/habr/upload_files/f49/989/4ff/f499894ffe127ba04951096630f941ce.png "Стандартный инструмент Excel на вкладке Данные → Структура")

Стандартный инструмент Excel на вкладке Данные → Структура

В результате данные разбиваются на группы близколежащих точек, для которых вычисляются средние цены и координаты:

![В строке 5 среднее строк 2 - 4](https://habrastorage.org/r/w1560/getpro/habr/upload_files/5f6/706/c0d/5f6706c0d85fa5fc4e8487ec820b70f9.png "В строке 5 среднее строк 2 - 4")

В строке 5 среднее строк 2 - 4

Для замены групп на точки со средними значениями → сворачиваем все группы, выделяем колонки координат и цены:

![Выделяем только нужные колонки](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/14b/2df/db4/14b2dfdb4addeb9a3dd39d2260405795.jpg "Выделяем только нужные колонки")

Выделяем только нужные колонки

Затем выделяем только видимые ячейки Ctrl+G → только видимые, копируем Ctrl+C:

![Так выглядят скопированные только видимые ячейки](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/fca/08f/faf/fca08ffafcdc09b568685704a753db56.jpg "Так выглядят скопированные только видимые ячейки")

Так выглядят скопированные только видимые ячейки

После чего вставляем скопированное на новый лист. Теперь на каждом здании будет не больше одной точки с данными, которая соответствует среднему значению всех относящихся к зданию объявлений:

![Одна точка вместо шести в результате их усреднения](https://habrastorage.org/r/w1560/getpro/habr/upload_files/3e4/6d4/30c/3e46d430cfd81abff92a72e97bfa0147.png "Одна точка вместо шести в результате их усреднения")

Одна точка вместо шести в результате их усреднения

С помощью такого приема можно провести усреднение цен на уровне группы зданий или по кварталу.

После такого прореживания осталось меньше половины точек. Благодаря этому карта цен будет значительно меньше перегружена данными в самых насыщенных местах.

Получившийся набор данных предстоит разложить по карманам в зависимости от величины цены. Для 7 цветов = 7 карманов гистограмма выглядит так:

![Гистограмма усредненных данных](https://habrastorage.org/r/w1560/getpro/habr/upload_files/88a/36d/d17/88a36dd1790af5f3d961fe84a6635293.png "Гистограмма усредненных данных")

Гистограмма усредненных данных

Данные из первого левого столбца гистограммы будут синего цвета, из последнего правого — красными, а из расположенных между ними — оттенками зеленого:

![Те же данные в боевой раскраске](https://habrastorage.org/r/w1560/getpro/habr/upload_files/a85/f89/c00/a85f89c0064858b07a9c737f1f7e5a28.png "Те же данные в боевой раскраске")

Те же данные в боевой раскраске

Цвет получается смешиванием красного (R), зеленого (G) и синего (B). Интенсивность каждого цвета находится в диапазоне от 0 до 255. Смешивание для получения показанных цветов приведено в следующей таблице.

<table><tbody><tr><td><p>Цвет</p></td><td><p><strong>R</strong></p></td><td><p><strong>G</strong></p></td><td><p><strong>B</strong></p></td><td><p><strong>Код</strong></p></td></tr><tr><td><p>&nbsp;Синий</p></td><td><p>0</p></td><td><p>171</p></td><td><p>255</p></td><td><p>0,171,255</p></td></tr><tr><td></td><td><p>0</p></td><td><p>171</p></td><td><p>171</p></td><td><p>0,171,171</p></td></tr><tr><td></td><td><p>0</p></td><td><p>255</p></td><td><p>171</p></td><td><p>0,255,171</p></td></tr><tr><td><p>&nbsp;Зеленый</p></td><td><p>0</p></td><td><p>255</p></td><td><p>0</p></td><td><p>0,255,0</p></td></tr><tr><td></td><td><p>171</p></td><td><p>255</p></td><td><p>0</p></td><td><p>171,255,0</p></td></tr><tr><td></td><td><p>255</p></td><td><p>85</p></td><td><p>0</p></td><td><p>255,85,0</p></td></tr><tr><td><p>&nbsp;Красный</p></td><td><p>255</p></td><td><p>42</p></td><td><p>0</p></td><td><p>255,42,0</p></td></tr></tbody></table>

 Обозначения из столбца **Код** будут использованы для окрашивания данных на карте.

Полученный результат можно считать подготовленными данными для отображения их на карте.

## Обработка

Имеющиеся цены разделим на 7 равных интервалов. (В этой области знаний интервалы синонимы диапазонов, и еще их называют карманами.)

Для определения ширины интервала разницу максимальной и минимальной цен нужно разделить на количество карманов. В нашем случае данные такие:

<table><tbody><tr><td><p>Минимум</p></td><td><p>4000</p></td></tr><tr><td><p>Максимум</p></td><td><p>109253,1</p></td></tr><tr><td><p>Кол-во карманов</p></td><td><p>7</p></td></tr><tr><td><p>Ширина кармана</p></td><td><p>15036</p></td></tr></tbody></table>

 И карманы:

<table><tbody><tr><td><p>1</p></td><td><p>3999</p></td><td><p>-</p></td><td><p>19035</p></td></tr><tr><td><p>2</p></td><td><p>19035</p></td><td><p>-</p></td><td><p>34071</p></td></tr><tr><td><p>3</p></td><td><p>34071</p></td><td><p>-</p></td><td><p>49107</p></td></tr><tr><td><p>4</p></td><td><p>49107</p></td><td><p>-</p></td><td><p>64144</p></td></tr><tr><td><p>5</p></td><td><p>64144</p></td><td><p>-</p></td><td><p>79180</p></td></tr><tr><td><p>6</p></td><td><p>79180</p></td><td><p>-</p></td><td><p>94216</p></td></tr><tr><td><p>7</p></td><td><p>94216</p></td><td><p>-</p></td><td><p>109253</p></td></tr></tbody></table>

Для получения данных первого кармана нужно скопировать данные широты и долготы для цен от 3999 до 19035 и вставить в новое место. Цены копировать не нужно, они использовались только для разбивки данных по карманам и больше не пригодятся. Аналогично для второго кармана копируем шир**о**ты и долг**о**ты для цен от 19035 до 34071 и вставляем их рядом с данными из первого кармана. Повторив семь раз получим в результате:

![Данные разложены по карманам](https://habrastorage.org/r/w1560/getpro/habr/upload_files/bda/cb1/ab2/bdacb1ab217be3190012ed628beb6e82.png "Данные разложены по карманам")

Данные разложены по карманам

В каждом кармане две колонки: левая — широта и правая — долгота. Количество строк в каждом кармане разное, как было показано на последней гистограмме.

Теперь данные полностью готовы для их помещения на карту.

## Карта

Для построения карты нужно сделать три шага:

_Добавить шаблон карты_ → _Заполнить шаблон данными_ → _Показать результат_

Шаблон карты добавляется кнопкой **Добавить** в меню парсера. Если в меню парсера нет кнопок для работы с картой, то в настройках парсера нужно включить опцию **Excel** → [**График на карте**](https://robastik.ru/features-plotting).

![Шаблон тепловой карты Excel](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/752/76a/53d/75276a53d446c1ac41235b742dffa9cd.jpg "Шаблон тепловой карты Excel")

Шаблон тепловой карты Excel

В первой строке шаблона указаны значения по умолчанию, которые можно изменять. В левой таблице вставляются подготовленные данные о ценах. Правая таблица служит для вывода на карте подписей к конкретным точкам.

Для вставки в шаблон данных о ценах из первого кармана нужно в ячейку A3 вставить ссылку на диапазон данных о широте и долготе, которые указаны в двух колонках первого кармана, вот эти:

![Фрагмент данных первого кармана](https://habrastorage.org/r/w1560/getpro/habr/upload_files/eae/3cc/6c5/eae3cc6c516fb0240913be19d77c15bc.png "Фрагмент данных первого кармана")

Фрагмент данных первого кармана

Для примера это диапазон Q4:R582 на листе **По карманам** в файле **Брянск 10(октябрь)-21.xlsx.**

Вставить ссылку на этот диапазон можно с помощью функции **Ссылка(**диапазон**)**.

В ячейке А3 шаблона пишем название функции:

![Пользовательская функция =Ссылка()](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/218/cb4/7bf/218cb47bf46325c920a481f81217454b.jpg "Пользовательская функция =Ссылка()")

Пользовательская функция =Ссылка()

В качестве единственного аргумента функции **Ссылка** указываем диапазон Q4:R582 на листе **По карманам:**

![Использование функции Ссылка](https://habrastorage.org/r/w1560/getpro/habr/upload_files/160/d9a/e0f/160d9ae0fd9e14623630e99f3a9a0334.png "Использование функции Ссылка")

Использование функции Ссылка

В результате получаем:

![Результат функции Ссылка](https://habrastorage.org/r/w1560/getpro/habr/upload_files/ed5/933/601/ed59336018d54f6cb90d07e113e0fb4d.png "Результат функции Ссылка")

Результат функции Ссылка

Точки данных первого кармана ранее условились обозначать синим цветом с кодом  0,171,255. Для примера формулы ниже: таблица с кодами цветов находится на листе **Палитра**. Код синего цвета находится в ячейке Е3:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/0e7/a3e/afa/0e7a3eafa5a5572fcb4eb26461a14c30.png)

Для вставки ссылки на ячейку в Excel не требуется использовать специальную функцию, поэтому в ячейке шаблона В3 вставляем ссылку на ячейку кода синего цвета обычным способом:

![](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/af9/34f/6ac/af934f6ac734aed79f4dfa398421b9b8.jpg)

В результате:

![](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/31b/f31/1cf/31bf311cfc38aef32e618e75c23e27b2.jpg)

Размер точек определяется из субъективных соображений. Для примера примем размер 10:

![](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/90a/8a9/36a/90a8a936a76b57409c3309350e7db6b5.jpg)

На этом шаблон карты полностью готов для отображения данных из первого кармана.

Посмотрим что получилось. Для этого нажимаем кнопку **Отобразить** в меню парсера, после чего открывается новое окно:

![Слишком крупный масштаб карты](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/655/e82/08f/655e8208f5d73d5831c02a7e28b56cd6.jpg "Слишком крупный масштаб карты")

Слишком крупный масштаб карты

Метки на карте отсутствуют из-за масштаба. Зумим колесом мышки и получаем:

![Визуализация данных первого кармана](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/232/cb5/4c9/232cb54c9cf07e6e5280c52cd9552c19.jpg "Визуализация данных первого кармана")

Визуализация данных первого кармана

Закрываем окно с картой, добавляем данные из второго кармана:

![Шаблон карты с данными двух первых карманов](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/14e/3aa/fce/14e3aafce204ce28b9ddf30c80368654.jpg "Шаблон карты с данными двух первых карманов")

Шаблон карты с данными двух первых карманов

Данные из второго кармана отображаются поверх данных первого кармана:

![Визуализация данных двух первых карманов](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/b2a/73c/6fc/b2a73c6fc2bd0dff97030b40461d5c4f.jpg "Визуализация данных двух первых карманов")

Визуализация данных двух первых карманов

После добавления всех оставшихся карманов:

![Полностью заполненный шаблон карты для всех карманов](https://habrastorage.org/r/w780q1/getpro/habr/upload_files/a22/ea7/d45/a22ea7d45841342bea5f032c4a4c7614.jpg "Полностью заполненный шаблон карты для всех карманов")

Полностью заполненный шаблон карты для всех карманов

На карте:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/198/931/3cb/1989313cbe28b1f67f74e8e5eb4f3577.png)

Это и есть визуализация цен на географической карте, сделанная в Excel без программирования. Ее можно зумить и двигать как обычную карту в браузере. Для копирования карты в буфер в парсере есть специальная кнопка **Копировать**.

В завершение отметим на карте какое-нибудь место, например [Аграрный университет](https://yandex.ru/profile/1591856089?no-distribution=1&source=wizbiz_new_map_single). Координаты широты и долготы БГАУ возьмем по указанной ссылке и вставим в ячейки J3 и К3. Ссылку на ячейки с координатами вставим в ячейку шаблона Н3:

![Заполненный шаблон метки на карте](https://habrastorage.org/r/w1560/getpro/habr/upload_files/7b8/427/370/7b8427370992d3afd89796bb0b871b98.png "Заполненный шаблон метки на карте")

Заполненный шаблон метки на карте

Увидим БГАУ на карте и оценим его влияние на цену недвижимости:

![Метка на карте в Excel](https://habrastorage.org/r/w1560/getpro/habr/upload_files/417/b81/d7a/417b81d7aa5548c6d9386771434e4178.png "Метка на карте в Excel")

Метка на карте в Excel

Файл Excel с примером можно скачать [здесь](https://docs.google.com/spreadsheets/d/1zDKZDsQot3zWbdEhGo-3xnBL6LwYSiH2/edit?usp=sharing&ouid=114774345817721406370&rtpof=true&sd=true).